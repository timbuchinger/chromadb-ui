name: Build & Test Docker Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci
      env:
        CYPRESS_INSTALL_BINARY: 0

    - name: Run linting
      run: npm run lint

    - name: Run unit tests with coverage
      run: npm run test:coverage

    - name: Upload coverage reports (lcov + HTML)
      uses: actions/upload-artifact@v5
      with:
        name: coverage-report
        path: coverage
        if-no-files-found: warn

    - name: Post coverage summary to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs')
          const pathCandidates = ['coverage/coverage-summary.json', 'coverage/coverage-final.json', 'coverage/coverage-summary.json']
          let data = null
          for (const p of pathCandidates) {
            if (fs.existsSync(p)) {
              try {
                data = JSON.parse(fs.readFileSync(p, 'utf8'))
                break
              } catch (e) {
                continue
              }
            }
          }

          if (!data || !data.total) {
            console.log('No coverage summary file found to post to PR.')
            return
          }

          const total = data.total
          const metrics = ['statements', 'lines', 'functions', 'branches']
          const rows = metrics.map(m => {
            const v = total[m] || {}
            const pct = v.pct !== undefined ? `${v.pct}%` : 'N/A'
            const covered = v.covered !== undefined ? v.covered : 'N/A'
            const tot = v.total !== undefined ? v.total : 'N/A'
            return `| ${m} | ${pct} | ${covered}/${tot} |`
          }).join('\n')

          const marker = '<!-- coverage-report -->'
          const body = `${marker}\n**Vitest Coverage Summary**\n\n| Metric | % | Covered / Total |\n|---:|---:|---:|\n${rows}\n\n_Generated by CI_`

          const pr = context.payload.pull_request
          if (!pr) {
            console.log('Not a pull request event; skipping comment')
            return
          }

          const owner = context.repo.owner
          const repo = context.repo.repo
          const pull_number = pr.number

          const { data: comments } = await github.issues.listComments({ owner, repo, issue_number: pull_number })
          const existing = comments.find(c => c.body && c.body.includes(marker))
          if (existing) {
            await github.issues.updateComment({ owner, repo, comment_id: existing.id, body })
          } else {
            await github.issues.createComment({ owner, repo, issue_number: pull_number, body })
          }

  e2e-test:
    runs-on: ubuntu-latest
    needs: lint-and-test
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v6

    - name: Start Chroma instances
      run: |
        docker compose -f docker/docker-compose.yaml up -d
        # Wait for services to be ready
        sleep 10

    - uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'

    - name: Cache Cypress binary
      uses: actions/cache@v4
      with:
        path: ~/.cache/Cypress
        key: cypress-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          cypress-${{ runner.os }}-

    - name: Install dependencies
      run: npm ci

    - name: Cypress tests
      run: npm run test:e2e
      env:
        CHROMA_SERVER_CORS_ALLOW_ORIGINS: "http://localhost:5173"

    - name: Cleanup
      if: always()
      run: docker compose -f docker/docker-compose.yaml down -v

  build:
    needs: e2e-test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v6

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        load: true
        tags: chromadb-ui:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test build
      run: |
        docker run --rm chromadb-ui:${{ github.sha }} nginx -t

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push
      uses: docker/build-push-action@v6
      with:
        platforms: linux/amd64,linux/arm64
        context: .
        push: true
        build-args: |
          VERSION=latest-${{ github.sha }}
        tags: |
          timbuchinger/chromadb-ui:latest
          timbuchinger/chromadb-ui:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
